trigger: none

variables:
  - name: acrRepository
    value: cars-island-web-api
  - name: image
    value: cars-web-api

stages:
  - stage: "docker_webapi_build_push"
    displayName: "Docker web API build push"
    jobs:
      - job: Build_Push_Docker_Image
        displayName: "Build push docker image"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 0

          - task: gitversion/setup@0
            displayName: 'GitVersion Setup'
            inputs:
              versionSpec: '5.9.x'

          - task: gitversion/execute@0
            displayName: 'GitVersion Execute'
            inputs:
              updateAssemblyInfo: true

          - bash: echo $Action$BuildVersion
            displayName: 'Set Build Version'
            env:
              Action: '##vso[build.updatebuildnumber]'
              BuildVersion: $(GitVersion.SemVer)

          - bash: |
              imageFullName="$(acrRepository):$(image)-$(GitVersion.SemVer)"
              echo "Image full name: $imageFullName"
              docker build -t "$imageFullName" "./src/cars-island-web-api"
            displayName: 'Build Docker Image'

          - bash: docker images
            displayName: 'List Docker Images'
            
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'CarsIslandACR_SP_Service_connection' 
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az acr login --name "carsislandacr"
            
#          - task: Docker@2
#            displayName: Login to ACR
#            inputs:
#              command: login
#              containerRegistry: 'CarsIslandACR_SP_Service_connection'
#              
#          - task: Docker@2
#            displayName: Build and Push
#            inputs:
#              command: buildAndPush
#              Dockerfile: 'src/cars-island-web-api/Dockerfile'
#              containerRegistry: 'CarsIslandACR_SP_Service_connection'
#              repository: '$(acrRepository)'
#              tags: |
#                $(GitVersion.SemVer)
#                latest