trigger: none

variables:
  - group: 'CarsIsland-Docker-Variables'

stages:
  - stage: "validate_docker_compose"
    displayName: "Validate Docker Compose"
    jobs:
      - job: Validate_Docker_Compose
        displayName: "Validate Docker Compose"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 0

          - task: AzureKeyVault@2
            inputs:
              azureSubscription: 'CarsIslandACR_SP_Service_connection'
              KeyVaultName: '$(KeyVaultName)' # inside variables group
              SecretsFilter: "*"
              RunAsPreJob: false

          - bash: |
              docker compose build
            displayName: 'Build Docker Compose'

          - bash: |
              docker compose up -d
            displayName: 'Run Docker Compose'

          - bash: |
              curl http://localhost:8080/api/Car/all
            displayName: 'Validate API'

          - bash: |
              curl http://localhost:8003/carscatalog
            displayName: 'Validate Web App'

          - bash: |
              docker compose down
            displayName: 'Stop Docker Compose'